<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>214 - 영어: 서술형 연습하기</title>
  <style>
    :root{
      --bg1:#ffd1e8; /* pink */
      --bg2:#e6d8ff; /* light lavender */
      --ink:#1f1d29;
      --muted:#6b6880;
      --ok:#14b8a6;
      --bad:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", AppleSDGothicNeo, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100svh; display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap{width:min(1100px,100%);}    
    .app{background:linear-gradient(135deg,#ffc1df,#d9c5ff); border-radius:24px; box-shadow:0 10px 30px #00000026; padding:20px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1}
    h1{font-size:clamp(18px,3vw,24px); margin:0 0 12px}
    .bar{display:grid; grid-template-columns:1fr; gap:8px; align-items:center}
    .selectors{display:flex; gap:8px; flex-wrap:wrap}
    select, button{border:1px solid #e5e5f0; background:#fff; padding:10px 12px; border-radius:var(--radius); font-size:15px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(135deg,#ff7bb0,#c69bff); color:#fff; border:none}
    button.ghost{background:#fff}
    .meta{color:var(--muted); font-size:13px}
    .card{background:linear-gradient(135deg,#fff2f8,#f0e8ff); border:1px solid #f3def0; border-radius:var(--radius); padding:14px}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr 1fr}}
    .label{font-size:13px; color:var(--muted); margin-bottom:6px}
    .meaning{font-size:18px}
    .zone{display:flex; flex-wrap:wrap; gap:8px; min-height:56px; padding:10px; border-radius:16px; background:linear-gradient(135deg,#ffe6f2,#efe6ff); border:1px dashed #e2bde0}
    .chip{display:inline-flex; align-items:center; padding:8px 12px; border-radius:999px; background:linear-gradient(135deg,#ff9ac7,#c7afff); color:#fff; border:0; font-weight:700; letter-spacing:.2px; user-select:none; cursor:pointer}
    .chip[disabled]{opacity:.5; pointer-events:none}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .status{font-size:14px; font-weight:700}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--bad)}
    .spacer{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" id="app">
      <div class="bar">
        <h1>영어 문장 배열 훈련</h1>
      </div>

      <div class="row" style="margin:12px 0 8px">
        <div class="selectors">
          <select id="selChapter" aria-label="대단원"></select>
          <select id="selSub" aria-label="소단원"></select>
          <select id="selSent" aria-label="문장"></select>
        </div>
        <div class="spacer"></div>
        <div class="meta" id="where">-</div>
      </div>

      <div class="grid" style="margin-top:8px">
        <div class="card">
          <div class="label">한국어 뜻</div>
          <div class="meaning" id="ko">-</div>
        </div>
        <div class="card">
          <div class="label">정답 문장(채점 후 표시)</div>
          <div id="answerKey" class="meta">-</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="label">단어 풀</div>
        <div id="pool" class="zone" aria-live="polite"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="label">문장 만들기</div>
        <div id="build" class="zone" aria-label="조합 영역"></div>
      </div>

      <div class="row" style="margin-top:12px; align-items:center">
        <div class="status" id="status"> </div>
        <div class="spacer"></div>
        <div class="actions">
          <button id="btnSubmit" class="primary">제출</button>
          <button id="btnReset" class="ghost">초기화</button>
          <button id="btnShuffle" class="ghost">섞기</button>
          <button id="btnNext" class="ghost">다음 문장</button>
        </div>
      </div>

      <details style="margin-top:10px">
        <summary class="meta">JSON 스키마 안내</summary>
        <pre class="meta" style="white-space:pre-wrap">
필수 키: chapters[].subchapters[].sentences[] 과 각 문장의 en, ko.
예시:
{
  "chapters": [
    {
      "title": "Unit 1",               // 선택적. 없으면 인덱스로 표시
      "subchapters": [
        {
          "title": "Lesson A",          // 선택적
          "sentences": [
            {"en": "I have breakfast at seven.", "ko": "나는 일곱 시에 아침을 먹는다."},
            {"en": "Don't be late for class.",  "ko": "수업에 지각하지 마라."}
          ]
        }
      ]
    }
  ]
}
- 대단원 7개, 각 소단원 4–6개, 소단원당 문장 0–3개 가능.
- 채점: 대소문자 무시, 구두점 무시, 공백은 하나 이상이면 통과.
        </pre>
      </details>
    </div>
  </div>

  <script>
  // ---------- 유틸 ----------
  const stripPunct = s => s.replace(/[“”\"\(\)\[\]\{\}<>:;.,!?—–-]+/g, "");
  const norm = s => stripPunct(s).replace(/\s+/g, " ").trim().toLowerCase();

  function tokenizeSentence(en){
    return en.split(/\s+/).map(t => t.replace(/^[^\w']+|[^\w']+$/g, "")).filter(Boolean);
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  // ---------- 상태 ----------
  let DATA = null;
  let idx = {c:0, s:0, t:0};
  let tokens = [];

  const el = id => document.getElementById(id);
  const selChapter = el('selChapter');
  const selSub = el('selSub');
  const selSent = el('selSent');
  const pool = el('pool');
  const build = el('build');
  const ko = el('ko');
  const where = el('where');
  const status = el('status');
  const answerKey = el('answerKey');

  function setStatus(msg, ok=null){
    status.textContent = msg;
    status.className = 'status' + (ok===true?' ok':ok===false?' bad':'');
  }

  // ---------- 렌더 ----------
  function currentSentence(){
    const chap = DATA.chapters[idx.c];
    const sub = chap?.subchapters?.[idx.s];
    const sent = sub?.sentences?.[idx.t];
    return {chap, sub, sent};
  }

  function fillSelectors(){
    // chapter
    selChapter.innerHTML = '';
    DATA.chapters.forEach((c,i)=>{
      const o = document.createElement('option');
      o.value=i; o.textContent = `${i+1}단원` + (c.title?` · ${c.title}`:'');
      selChapter.appendChild(o);
    });
    selChapter.value = idx.c;

    // subchapter
    selSub.innerHTML = '';
    const subs = DATA.chapters[idx.c].subchapters||[];
    subs.forEach((s,i)=>{
      const o = document.createElement('option');
      o.value=i; o.textContent = `${i+1}소단원` + (s.title?` · ${s.title}`:'');
      selSub.appendChild(o);
    });
    idx.s = Math.min(idx.s, Math.max(0, subs.length-1));
    selSub.value = idx.s;

    // sentence
    selSent.innerHTML = '';
    const sents = subs[idx.s]?.sentences||[];
    sents.forEach((t,i)=>{
      const o = document.createElement('option');
      o.value=i; o.textContent = `${i+1}번 문장`;
      selSent.appendChild(o);
    });
    idx.t = Math.min(idx.t, Math.max(0, sents.length-1));
    if (sents.length>0) selSent.value = idx.t;
  }

  function renderWhere(){
    where.textContent = `${idx.c+1}단원 · ${idx.s+1}소단원 · ${idx.t+1}번`;
  }

  function renderProblem(){
    const {sent} = currentSentence();
    if(!sent){
      ko.textContent = '(문장이 없습니다)';
      pool.innerHTML=''; build.innerHTML=''; answerKey.textContent='-';
      setStatus('');
      return;
    }
    ko.textContent = sent.ko || '-';

    const ts = tokenizeSentence(sent.en);
    tokens = shuffle(ts).map(t => t.toLowerCase());

    pool.innerHTML = '';
    build.innerHTML = '';
    tokens.forEach(tok=> pool.appendChild(makeChip(tok, ()=> moveToBuild(tok))));

    answerKey.textContent = '-';
    setStatus('');
    renderWhere();
  }

  function makeChip(text, onClick){
    const c = document.createElement('button');
    c.className='chip'; c.type='button'; c.textContent=text; c.addEventListener('click', onClick);
    return c;
  }

  function moveToBuild(tok){
    const btn = [...pool.children].find(x=>x.textContent===tok);
    if(!btn) return;
    pool.removeChild(btn);
    build.appendChild(makeChip(tok, ()=> moveBack(tok)));
  }

  function moveBack(tok){
    const btn = [...build.children].find(x=>x.textContent===tok);
    if(!btn) return;
    build.removeChild(btn);
    pool.appendChild(makeChip(tok, ()=> moveToBuild(tok)));
  }

  function resetBuild(){
    const chosen = [...build.children].map(x=>x.textContent);
    chosen.forEach(tok=> moveBack(tok));
    setStatus('');
    answerKey.textContent='-';
  }

  function submit(){
    const {sent} = currentSentence();
    if(!sent) return;
    const user = [...build.children].map(x=>x.textContent).join(' ').trim();
    const gold = tokenizeSentence(sent.en).join(' ');

    const ok = norm(user) === norm(gold);
    setStatus(ok? '정답' : '오답', ok);
    if(ok){
      answerKey.textContent = sent.en;
    } else {
      answerKey.textContent = '(오답)';
    }
  }

  function nextSentence(){
    const subs = DATA.chapters[idx.c].subchapters||[];
    const sents = subs[idx.s]?.sentences||[];
    if(sents.length===0) return;
    if(idx.t < sents.length-1){ idx.t++; }
    else {
      if(idx.s < subs.length-1){ idx.s++; idx.t=0; }
      else {
        if(idx.c < DATA.chapters.length-1){ idx.c++; idx.s=0; idx.t=0; }
        else { idx.c=0; idx.s=0; idx.t=0; }
      }
    }
    fillSelectors();
    renderProblem();
  }

  selChapter.addEventListener('change', e=>{ idx.c=+e.target.value; idx.s=0; idx.t=0; fillSelectors(); renderProblem(); });
  selSub.addEventListener('change', e=>{ idx.s=+e.target.value; idx.t=0; fillSelectors(); renderProblem(); });
  selSent.addEventListener('change', e=>{ idx.t=+e.target.value; renderProblem(); });

  document.getElementById('btnReset').addEventListener('click', resetBuild);
  document.getElementById('btnShuffle').addEventListener('click', ()=>{ renderProblem(); });
  document.getElementById('btnSubmit').addEventListener('click', submit);
  document.getElementById('btnNext').addEventListener('click', nextSentence);

  // ---------- 데이터 로드 ----------
  const DATA_URL = 'data.json';
  async function boot(){
    try {
      const res = await fetch(DATA_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const parsed = await res.json();
      if(!parsed.chapters) throw new Error('chapters 키 없음');
      DATA = parsed;
      idx={c:0,s:0,t:0};
      fillSelectors();
      renderProblem();
      setStatus('데이터 로드 완료');
    } catch(err) {
      setStatus('data.json 로드 실패. 동일 폴더에 배치하세요: '+err.message, false);
    }
  }
  boot();
  </script>
</body>
</html>
